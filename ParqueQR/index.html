<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Tickets - Parque de Diversiones</title>
  <style>
    #qr-code {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #scanner {
      display: none;
      margin-top: 20px;
      width: 100%;
      max-width: 500px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #ticket-stats {
      margin-top: 20px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Bienvenido al Parque de Diversiones üé¢</h1>
  <button onclick="generarTicket()">Generar Ticket</button>
  <button onclick="abrirEscaner()">Escanear QR</button>
  <button onclick="verTickets()">Ver Tickets Generados</button>
  <button onclick="exportarTicketsCSV()">Exportar Tickets a CSV</button>
  <button onclick="exportarTicketsExcel()">Exportar Tickets a Excel</button>


  <div id="ticket-stats">Tickets Usados: 0 | Tickets No Usados: 0</div>

  <div id="qr-code"></div>
  <video id="scanner" autoplay playsinline></video>

  <input type="text" id="buscarTicket" placeholder="Buscar por c√≥digo QR..." onkeyup="filtrarTickets()">

  <h2>Tickets Generados</h2>
  <table id="tabla-tickets">
    <thead>
      <tr>
        <th>C√≥digo QR</th>
        <th>Fecha</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.3.1/lib/qr-code-styling.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDJeze6ibv446maeLso00v5hWx-7o3vpc",
      authDomain: "parquediversiones-5bef1.firebaseapp.com",
      projectId: "parquediversiones-5bef1",
      storageBucket: "parquediversiones-5bef1.appspot.com",
      messagingSenderId: "534239241861",
      appId: "1:534239241861:web:1113c526f8cfe17c996bec"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function generarCodigoQR() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    async function guardarTicket(codigoQR) {
      try {
        const docRef = await addDoc(collection(db, "tickets"), {
          codigoQR: codigoQR,
          fecha: new Date(),
          usado: false
        });
        actualizarEstadisticas();
        return { id: docRef.id, codigoQR };
      } catch (e) {
        console.error("Error a√±adiendo documento: ", e);
      }
    }

    async function generarTicket() {
      const qrCodeContainer = document.getElementById("qr-code");
      qrCodeContainer.innerHTML = "";
      const { id, codigoQR } = await guardarTicket(generarCodigoQR());
      if (!id) return;

      const ticketURL = `https://tuapp.com/ticket/${codigoQR}`;
      const qrCode = new QRCodeStyling({
        width: 250,
        height: 250,
        type: "svg",
        data: ticketURL,
        dotsOptions: { color: "#000", type: "rounded" },
        backgroundOptions: { color: "#FFF" }
      });
      qrCode.append(qrCodeContainer);
    }

    async function verTickets() {
      const tabla = document.querySelector("#tabla-tickets tbody");
      tabla.innerHTML = "";
      const q = query(collection(db, "tickets"), orderBy("fecha", "desc"));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((doc) => {
        const ticket = doc.data();
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${ticket.codigoQR}</td>
          <td>${new Date(ticket.fecha.toDate()).toLocaleString()}</td>
          <td>${ticket.usado ? "‚úÖ Usado" : "‚ùå No usado"}</td>
          <td><button class="delete-btn" onclick="eliminarTicket('${doc.id}')">Eliminar</button></td>
        `;
        tabla.appendChild(fila);
      });
      actualizarEstadisticas();
    }

   // Funci√≥n para exportar tickets a CSV (formato compatible con Excel)
      async function exportarTicketsCSV() {
  // Consulta ordenada cronol√≥gicamente
  const q = query(collection(db, "tickets"), orderBy("fecha", "asc"));
  const querySnapshot = await getDocs(q);

  // Iniciar el contenido con los encabezados, usando espacios para simular el ancho
  let csvContent = "C√≥digo QR         ;Fecha                  ;Estado\n";

  // Recopilar datos y agregar al contenido CSV
  querySnapshot.forEach((doc) => {
    const ticket = doc.data();
    const codigoQR = ticket.codigoQR.padEnd(15, " "); // Ajuste de longitud
    const fecha = new Date(ticket.fecha.toDate()).toLocaleString().padEnd(20, " ");
    const estado = (ticket.usado ? "Usado" : "No usado").padEnd(10, " ");
    csvContent += `${codigoQR};${fecha};${estado}\n`;
  });

  // Crear el archivo CSV y descargarlo
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  saveAs(blob, "tickets.csv");
}

// Funci√≥n para exportar tickets a Excel (ordenados cronol√≥gicamente correctamente)
async function exportarTicketsExcel() {
  // Consultar todos los tickets sin ordenar
  const q = query(collection(db, "tickets"));
  const querySnapshot = await getDocs(q);
  const datos = [];

  // Recopilar datos con timestamp para ordenarlos despu√©s
  querySnapshot.forEach((doc) => {
    const ticket = doc.data();
    const fecha = ticket.fecha.toDate();
    datos.push({
      "C√≥digo QR": ticket.codigoQR,
      "Fecha": fecha.toLocaleString("es-ES"), // Fecha legible para Excel
      "Timestamp": fecha.getTime(), // Timestamp para ordenar
      "Estado": ticket.usado ? "Usado" : "No usado"
    });
  });

  // Ordenar por timestamp (milisegundos)
  datos.sort((a, b) => b.Timestamp - a.Timestamp);

  // Eliminar el campo Timestamp para la exportaci√≥n
  const datosFormateados = datos.map(item => ({
    "C√≥digo QR": item["C√≥digo QR"],
    "Fecha": item["Fecha"],
    "Estado": item["Estado"]
  }));

  // Crear hoja de c√°lculo
  const ws = XLSX.utils.json_to_sheet(datosFormateados);

  // Establecer el ancho de las columnas
  ws['!cols'] = [
    { wch: 15 }, // C√≥digo QR
    { wch: 24 }, // Fecha
    { wch: 12 }  // Estado
  ];

  // Crear libro de trabajo y exportar
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Tickets");
  XLSX.writeFile(wb, "tickets.xlsx");
}

    async function actualizarEstadisticas() {
      const q = query(collection(db, "tickets"));
      const querySnapshot = await getDocs(q);
      let usados = 0;
      let noUsados = 0;

      querySnapshot.forEach((doc) => {
        const ticket = doc.data();
        ticket.usado ? usados++ : noUsados++;
      });

      document.getElementById("ticket-stats").textContent = `Tickets Usados: ${usados} | Tickets No Usados: ${noUsados}`;
    }

    function filtrarTickets() {
      const input = document.getElementById("buscarTicket").value.toUpperCase();
      const filas = document.querySelectorAll("#tabla-tickets tbody tr");
      filas.forEach(fila => {
        const codigoQR = fila.cells[0].textContent.toUpperCase();
        fila.style.display = codigoQR.includes(input) ? "" : "none";
      });
    }

    async function eliminarTicket(ticketId) {
      if (confirm("¬øEst√°s seguro de que quieres eliminar este ticket?")) {
        try {
          const ticketRef = doc(db, "tickets", ticketId);
          await deleteDoc(ticketRef);
          alert("üóëÔ∏è Ticket eliminado correctamente.");
          verTickets();
          actualizarEstadisticas();
        } catch (e) {
          console.error("Error eliminando ticket:", e);
          alert("‚ùå Error eliminando el ticket. Revisa la consola.");
        }
      }
    }

    async function abrirEscaner() {
      const scanner = document.getElementById('scanner');
      scanner.style.display = 'block';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        scanner.srcObject = stream;
        detectarQR(scanner);
      } catch (error) {
        alert("No se pudo acceder a la c√°mara. Verifica los permisos.");
        console.error("Error de c√°mara:", error);
      }
    }

    function detectarQR(scanner) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      function captura() {
        if (scanner.readyState === scanner.HAVE_ENOUGH_DATA) {
          canvas.width = scanner.videoWidth;
          canvas.height = scanner.videoHeight;
          context.drawImage(scanner, 0, 0, canvas.width, canvas.height);
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            const codigoExtraido = extraerCodigoQR(code.data);
            verificarTicket(codigoExtraido);
            detenerEscaner(scanner);
          } else {
            requestAnimationFrame(captura);
          }
        } else {
          requestAnimationFrame(captura);
        }
      }
      captura();
    }

    function extraerCodigoQR(url) {
      try {
        const urlObj = new URL(url);
        return urlObj.pathname.split("/").pop();
      } catch (e) {
        return url;
      }
    }

    async function verificarTicket(codigoQR) {
      const q = query(collection(db, "tickets"), where("codigoQR", "==", codigoQR));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        alert("‚ùå Ticket no v√°lido.");
        return;
      }
      querySnapshot.forEach(async (documento) => {
        const ticketData = documento.data();
        const ticketRef = doc(db, "tickets", documento.id);
        if (ticketData.usado) {
          alert("‚ö†Ô∏è Ticket ya ha sido utilizado.");
        } else {
          await updateDoc(ticketRef, { usado: true });
          alert("‚úÖ Ticket v√°lido. Acceso concedido.");
          actualizarEstadisticas();
        }
      });
    }

    function detenerEscaner(scanner) {
      scanner.srcObject.getTracks().forEach(track => track.stop());
      scanner.style.display = 'none';
    }

    window.generarTicket = generarTicket;
    window.abrirEscaner = abrirEscaner;
    window.verTickets = verTickets;
    window.filtrarTickets = filtrarTickets;
    window.eliminarTicket = eliminarTicket;
    window.exportarTicketsCSV = exportarTicketsCSV;
    window.exportarTicketsExcel = exportarTicketsExcel;
    window.onload = actualizarEstadisticas;
  
  </script>
</body>
</html>
